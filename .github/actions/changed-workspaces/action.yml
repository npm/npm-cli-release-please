# This file is automatically added by @npmcli/template-oss. Do not edit.

name: Get Changed Workspaces

inputs:
  token:
    description: GitHub token to use
    required: true
  shell:
    description: shell to run on
    default: bash

outputs:
  files:
    value: ${{ steps.files.outputs.result }}
  flags:
    value: ${{ steps.workspaces.outputs.flags }}

runs:
  using: composite
  steps:
    - name: Get Changed Files
      uses: actions/github-script@v6
      id: files
      with:
        github-token: ${{ inputs.token }}
        script: |
          const { repo: { owner, repo }, eventName, payload, sha } = context

          console.log({ eventName, payload, sha })

          if (eventName === 'pull_request' || eventName === 'pull_request_target') {
            const resFiles = github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: payload.pull_request.number,
            })

            console.log(resFiles)

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: payload.pull_request.number,
            }))

            console.log(files)

            return files
          }

          const res = github.rest.repos.getCommit({
            owner,
            repo,
            ref: sha,
          })

          console.log(JSON.stringify(res.data, null, 2))

          return commit

    - name: Get Workspaces
      shell: ${{ inputs.shell }}
      id: workspaces
      run: |
        flags=$(npm exec --offline -- template-oss-changed-workspaces "${{ steps.files.outputs.result }}"
        echo "flags=${flags}" >> $GITHUB_OUTPUT
